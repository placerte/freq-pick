# handoff-260220-1.md

## Problem framing

`wav-to-freq` currently requires choosing **N peaks** in advance. That forces a guessing step before seeing the spectrum, and can lead to either missing intended modes (N too small) or wasting time fitting unnecessary decays (N too large). We want a **small, standalone** package that lets a human **select frequencies-of-interest (FOIs)** directly from a **provided spectrum**, producing reproducible artifacts and a machine-readable selection.

A recurring UX issue in structural modal work is that spectra are often displayed up to Nyquist (e.g., ~22 kHz for 44.1 kHz sampling) even though the window of interest might be much smaller (e.g., 0–200 Hz, 0–500 Hz, etc.). This package may accept an optional **frequency view window** to focus the UI on the relevant band.

**Note:** true frequency resolution (Δf) is determined upstream by how the spectrum was computed (record length / FFT length / zero padding / windowing). This picker may *focus* (limit display and optional selection) but does not change inherent resolution.

## Scope

### In scope
- Matplotlib-based interactive picker for selecting FOIs from a **single** spectrum (`f_hz`, `mag`).
- Snap-to-peak selection (deterministic).
- Optional rectangle selection to define the snap window.
- API-first design + CLI entry point for standalone use.
- Artifact generation (PNG + JSON) mirroring the “manual workflow” feel of `envelope-decay-fit`.

### Out of scope
- Computing FFT/spectrum from WAV.
- Envelope extraction.
- Decay fitting / ζ computation.
- Multi-channel signal processing.
- Auto-suggested candidate peaks (v0.1).
- `wav-to-freq` integration (separate workload).

## Locked decisions

### D-260220_1-1 (Manual-only v0.1)
- No candidate-peak suggestions in v0.1.
- User picks manually via UI.

### D-260220_1-2 (Spectrum-agnostic)
- The package receives **one spectrum per session**.
- Upstream decides whether the spectrum is per-hit, aggregated, etc.

### D-260220_1-3 (Inputs)
- Use `Spectrum` dataclass:
  - `f_hz: np.ndarray` (strictly increasing)
  - `mag: np.ndarray` (same length)
  - `display_domain: Literal['linear','dB']` (caller chooses; default `'dB'`)
  - `meta: dict` (optional)
- No conversion between linear/dB inside the picker.

### D-260220_1-4 (Outputs)
- Return `Selection` dataclass:
  - `selected_hz: list[float]` (raw bin freqs)
  - `selected_idx: list[int]` (bin indices; used for deterministic toggle)
  - `settings: dict`
  - `meta: dict`
- De-duplication is **index-based**.
- Store raw floats; UI rounds for labels.

### D-260220_1-5 (Snap-to-peak)
- Snap strategy is **max-in-window**.
- Snap window is **hybrid**:
  - `effective_snap_hz = max(user_snap_hz, 3 * df)`
- No gating: always accept max bin in window.
- If multiple peaks in window: choose highest magnitude.

### D-260220_1-6 (UI interactions)
- Matplotlib UI, blocking.
- Selection requires a **modifier key** to avoid fighting pan/zoom:
  - `Shift + Left click` → toggle max-in-window around cursor (±effective_snap_hz).
  - `Shift + Drag` (rectangle selector) → toggle max-in-rectangle.
- Keymap mirrors `envelope-decay-fit` convention:
  - `q` = commit + quit.
  - `Esc` = cancel.
  - `c` = clear.
  - `h` = toggle help overlay (help hidden by default).
- Visuals:
  - selected peaks: vertical lines + `xx.xx Hz` labels
  - corner summary list of selected peaks.

### D-260220_1-7 (Artifacts)
- API is primary; CLI exists.
- Artifacts are optional and caller-controlled.
- Artifact format: **JSON**.
- Naming policy:
  - caller passes `artifact_dir` and `artifact_stem`
  - write `{stem}_pick.png` and `{stem}_pick.json`
- No “load/edit selection” in v0.1.

### D-260220_1-8 (Errors / edge cases)
- Commit with zero selected peaks is allowed (warn).
- Invalid inputs raise `ValueError` (API); CLI exits non-zero.
- No implicit frequency clipping, but the user/caller may provide an optional frequency view window (see D-260220_1-8.1).
- Dense peaks: rely on tighter snap window and rectangle selection.
- No special decimation/perf work in v0.1.

### D-260220_1-8.1 (Frequency view window)
- Optional `xlim=(fmin,fmax)` focuses the displayed frequency band.
- This is primarily a **UI concern**; callers can also pre-crop the spectrum upstream.
- If enabled (`crop_to_xlim=True`), selection is limited to the view window for convenience.
- Windowing is a view/crop only; it does not change underlying spectrum resolution.
- The window is recorded in artifacts (`settings.xlim`).

### D-260220_1-9 (Deps / Python) (Deps / Python)
- Dependencies: `numpy`, `matplotlib` only.
- Python: **3.13**.
- CLI: `python -m <pkg>` and a console script.

## Specs

### S-260220_1-1 (Core API)
Provide:
- `Spectrum` dataclass
- `Selection` dataclass
- `pick_freqs_matplotlib(
    spectrum: Spectrum,
    *,
    user_snap_hz: float = 0.5,
    modifier: str = 'shift',
    artifact_dir: Path | None = None,
    artifact_stem: str | None = None,
    xlim: tuple[float,float] | None = None,
    title: str | None = None,
    crop_to_xlim: bool = True,
) -> Selection`

`xlim` is the **frequency view window** (e.g., `(0.0, 200.0)`). If `crop_to_xlim=True`, the picker limits display and selection to that window (recommended).

Cancel behavior:
- API raises `PickerCancelled` on cancel.

### S-260220_1-2 (Rectangular selection)
- Implement rectangle selector that, when activated with the same modifier, selects the maximum-magnitude bin within the rectangle and toggles that selection.

### S-260220_1-3 (Selection toggling)
- Selecting an already-selected bin index toggles it off.
- Selection state is deterministic and stored as indices + frequencies.

### S-260220_1-4 (Artifacts)
When `artifact_dir` and `artifact_stem` are provided:
- Write PNG of the spectrum with overlays.
- Write JSON selection artifact with the schema below.

### S-260220_1-5 (CLI)
Provide a standalone CLI that:
- Loads a spectrum from **`.npz`** containing `f_hz` and `mag` arrays.
- Launches the picker.
- Writes artifacts to the chosen output directory.
- Exits non-zero on error/cancel.

## Artifact schema

### S-260220_1-6 (JSON schema fields)
Required top-level keys:
- `schema_version` (string, e.g. `"1"`)
- `selected_hz` (array of floats)
- `selected_idx` (array of ints)
- `settings` (object)
- `spectrum_meta` (object)
- `display_domain` (`"linear"` or `"dB"`)

Recommended `settings`:
- `user_snap_hz`
- `effective_snap_hz`
- `df_hz` (computed)
- `modifier` (e.g. `"shift"`)
- `picker_keymap` (object)
- `xlim` (optional)

Recommended `spectrum_meta`:
- a shallow copy of `Spectrum.meta` (if provided)

## Implementation plan

### I-260220_1-1 (Project skeleton)
- `src/<pkg_name>/core.py` (dataclasses, validation, snapping logic)
- `src/<pkg_name>/mpl_ui.py` (matplotlib figure, event handlers, rectangle selector)
- `src/<pkg_name>/artifacts.py` (PNG + JSON write)
- `src/<pkg_name>/cli.py` (npz load, args, run picker)
- `src/<pkg_name>/__init__.py`
- `tests/`

### I-260220_1-2 (Validation)
- Validate 1D arrays, equal length, strictly increasing `f_hz`, finite values.

### I-260220_1-3 (Snap utilities)
- Compute `df_hz` as median of `np.diff(f_hz)` (warn if non-uniform > tolerance).
- `effective_snap_hz = max(user_snap_hz, 3 * df_hz)`
- Convert snap window to index bounds using `np.searchsorted`.
- Choose `idx = argmax(mag[idx_lo:idx_hi]) + idx_lo`.
- If `xlim` is provided and `crop_to_xlim=True`, selection logic operates only within the cropped arrays (display + selection focus).

### I-260220_1-4 ### I-260220_1-4 (Matplotlib events)
- Use `mpl_connect` for mouse + key events.
- Only act on selection when `shift` modifier is present.
- Use `matplotlib.widgets.RectangleSelector` gated behind the same modifier.

### I-260220_1-5 (Rendering overlays)
- Maintain selected indices set.
- On update: clear/re-draw overlay artists (or update existing artists efficiently).
- Labels: display `f_hz[idx]` rounded (e.g. 2–3 decimals).
- Corner summary: sorted list by frequency.

### I-260220_1-6 (Artifacts)
- PNG: save the current figure state.
- JSON: dump selection + settings + meta.

### I-260220_1-7 (CLI)
- Input `.npz` keys: `f_hz`, `mag`.
- Args:
  - `--in <path.npz>`
  - `--out <dir>`
  - `--stem <name>`
  - `--snap-hz <float>`
  - `--domain linear|dB` (metadata only)
  - `--xlim fmin fmax` (optional; frequency view window, e.g. `0 200`)
  - `--title <str>` (optional)
- Behavior:
  - Run picker.
  - On commit: write artifacts, exit 0.
  - On cancel: exit non-zero.

## Tests

### T-260220_1-1 (Snap behavior)
- Synthetic spectrum with known peak locations.
- Verify max-in-window returns expected idx for various click frequencies.

### T-260220_1-2 (Toggle by index)
- Select same peak twice → removed.

### T-260220_1-3 (JSON schema)
- Artifact JSON includes all required keys.

### T-260220_1-4 (Headless render)
- Force matplotlib Agg backend in test.
- Save PNG and assert file exists and is non-empty.

## Definition of Done

### DoD-260220_1-1 (v0.1)
- API implemented: `Spectrum`, `Selection`, `pick_freqs_matplotlib`.
- Shift+click toggles peak (hybrid snap rule).
- Shift+drag rectangle toggles max-in-box.
- `q` commits and returns `Selection`.
- `Esc` cancels and raises `PickerCancelled`.
- Optional artifacts written when `artifact_dir`+`artifact_stem` provided.
- CLI works with `.npz` input and writes `{stem}_pick.png/json`.
- Tests T-260220_1-1..1-4 pass on Python 3.13.

## Open items (not part of this handoff)
- Auto-suggest candidate peaks.
- Round-trip load/edit of selections.
- Integration into `wav-to-freq` CLI and workflow.
- Additional selection modes (multi-band, bandwidth estimation).

